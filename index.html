<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SBO Auftragsformular Digital 2025</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{--P:#1a1a2e;--A:#e8352a;--S:#fff;--S2:#f7f6f3;--S3:#eeecea;--B:#d8d5cf;--T:#1a1a2e;--T2:#6b6860;--G:#2d7a4f;--r:8px}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',sans-serif;background:#f0ede8;color:var(--T);min-height:100vh}
/* HEADER */
.hdr{background:var(--P);position:sticky;top:0;z-index:100;box-shadow:0 4px 24px rgba(0,0,0,.3)}
.hdr-in{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:13px 22px;gap:12px}
.logo{display:flex;align-items:center;gap:13px}
.lm{background:var(--A);color:#fff;font-family:'DM Serif Display',serif;font-size:20px;width:42px;height:42px;display:flex;align-items:center;justify-content:center;border-radius:6px;flex-shrink:0}
.lt h1{font-family:'DM Serif Display',serif;font-size:16px;font-weight:400;color:#fff}
.lt p{font-size:10px;color:rgba(255,255,255,.45);letter-spacing:1px;text-transform:uppercase}
.ha{display:flex;gap:7px;flex-shrink:0}
.pb{background:rgba(255,255,255,.1);height:3px}
.pf{height:100%;background:var(--A);transition:width .4s}
/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 15px;border-radius:var(--r);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;cursor:pointer;border:none;transition:all .18s;white-space:nowrap}
.bp{background:var(--A);color:#fff}.bp:hover{background:#c42820}
.bs{background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.2)}.bs:hover{background:rgba(255,255,255,.22)}
.bo{background:transparent;color:var(--T);border:1.5px solid var(--B)}.bo:hover{border-color:var(--A);color:var(--A)}
.bg2{background:var(--G);color:#fff}.bg2:hover{background:#226040}
.bbl{background:#2563eb;color:#fff}.bbl:hover{background:#1d4ed8}
/* STEPS */
.snav{background:var(--S);border-bottom:1px solid var(--B);overflow-x:auto}
.sin{max-width:1100px;margin:0 auto;display:flex;padding:0 22px}
.stab{display:flex;align-items:center;gap:8px;padding:14px 16px 12px;cursor:pointer;border-bottom:2.5px solid transparent;font-size:12px;font-weight:500;color:var(--T2);white-space:nowrap;transition:all .2s}
.stab:hover{color:var(--T)}.stab.active{color:var(--A);border-bottom-color:var(--A)}.stab.done{color:var(--G)}
.sn{width:21px;height:21px;border-radius:50%;background:var(--S3);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;font-family:'JetBrains Mono',monospace;transition:all .2s}
.stab.active .sn{background:var(--A);color:#fff}.stab.done .sn{background:var(--G);color:#fff}
/* MAIN */
.main{max-width:1100px;margin:0 auto;padding:24px 22px 100px}
/* CARDS */
.card{background:var(--S);border-radius:12px;border:1px solid var(--B);box-shadow:0 2px 16px rgba(26,26,46,.07);margin-bottom:18px;overflow:hidden}
.ch{display:flex;align-items:center;gap:11px;padding:14px 20px;background:var(--S2);border-bottom:1px solid var(--B)}
.ci{width:32px;height:32px;background:var(--P);color:#fff;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.ct h3{font-size:13px;font-weight:600}.ct p{font-size:11px;color:var(--T2);margin-top:2px}
.cb{padding:20px}
/* FORM */
.fg{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:13px}
.c2{grid-column:span 2}
.f{display:flex;flex-direction:column;gap:4px}
.f label{font-size:10px;font-weight:600;color:var(--T2);text-transform:uppercase;letter-spacing:.8px}
.code{font-family:'JetBrains Mono',monospace;background:var(--S3);color:var(--A);padding:1px 5px;border-radius:3px;font-size:10px;margin-right:3px}
.f input,.f select,.f textarea{border:1.5px solid var(--B);border-radius:var(--r);padding:8px 10px;font-family:'DM Sans',sans-serif;font-size:13px;color:var(--T);background:var(--S);transition:border-color .18s;width:100%}
.f input:focus,.f select:focus,.f textarea:focus{outline:none;border-color:var(--A);box-shadow:0 0 0 3px rgba(232,53,42,.1)}
.f input.af{background:#f0fdf4;border-color:var(--G);animation:fg2 .8s ease}
@keyframes fg2{0%{background:#bbf7d0}100%{background:#f0fdf4}}
/* CAMERA */
.cz{border:2px dashed var(--B);border-radius:12px;padding:28px 20px;text-align:center;background:var(--S2);transition:all .2s;cursor:pointer;position:relative;min-height:150px}
.cz:hover{border-color:var(--A);background:#fff8f7}.cz.hi{border-style:solid;border-color:var(--G)}
.ci2{font-size:36px;margin-bottom:10px;display:block}.cz h4{font-size:14px;font-weight:600;margin-bottom:5px}.cz p{font-size:12px;color:var(--T2)}
#vip{max-width:100%;max-height:240px;border-radius:8px;margin-top:12px;display:none}
/* SPINNER */
.so{position:absolute;inset:0;background:rgba(255,255,255,.93);display:none;flex-direction:column;align-items:center;justify-content:center;border-radius:10px;z-index:10;gap:10px}
.sp2{width:32px;height:32px;border:3px solid var(--S3);border-top-color:var(--A);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.stxt{font-size:12px;color:var(--T2);font-weight:500}
/* OCR RESULT */
.orbox{background:#f0fdf4;border:1px solid #86efac;border-radius:8px;padding:12px;margin-top:12px;display:none}
.orbox h5{font-size:11px;font-weight:600;color:var(--G);margin-bottom:8px;text-transform:uppercase;letter-spacing:.8px}
.ofs{display:flex;flex-wrap:wrap;gap:6px}
.ot{background:#dcfce7;border:1px solid #86efac;border-radius:4px;padding:3px 8px;font-size:11px;color:#166534;font-family:'JetBrains Mono',monospace}
/* OCR ERROR */
.errbox{background:#fef2f2;border:1px solid #fca5a5;border-radius:8px;padding:14px;margin-top:12px;display:none}
.errbox h5{font-size:12px;font-weight:600;color:#dc2626;margin-bottom:6px}
.errbox p{font-size:11px;color:#7f1d1d;line-height:1.6;white-space:pre-wrap}
/* SIGNATURE */
.sc{position:relative;border:2px solid var(--B);border-radius:var(--r);background:#fff;overflow:hidden}
.sc canvas{display:block;width:100%;height:160px;cursor:crosshair;touch-action:none}
.sl{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);font-size:10px;color:var(--T2);pointer-events:none;display:flex;align-items:center;gap:5px;white-space:nowrap}
.sli{width:70px;height:1px;background:var(--B)}
.sa{display:flex;gap:7px;margin-top:8px;align-items:center}
.ss{font-size:12px;padding:5px 10px;border-radius:4px;background:var(--S2);color:var(--T2)}.ss.ok{background:#f0fdf4;color:var(--G)}
/* TOGGLE */
.qr{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--B);gap:12px}
.qr:last-child{border-bottom:none}.qr p{font-size:13px;font-weight:500;flex:1}
.tg{display:flex;border:1.5px solid var(--B);border-radius:6px;overflow:hidden}
.tb{padding:6px 13px;font-size:12px;font-weight:500;cursor:pointer;background:none;border:none;color:var(--T2);transition:all .15s;font-family:'DM Sans',sans-serif}
.tb.ay{background:var(--G);color:#fff}.tb.an{background:var(--P);color:#fff}
/* STEPS */
.sc2{display:none}.sc2.active{display:block}
/* BOTTOM NAV */
.bn{position:fixed;bottom:0;left:0;right:0;background:var(--S);border-top:1px solid var(--B);padding:12px 22px;display:flex;justify-content:space-between;align-items:center;z-index:50;box-shadow:0 -4px 20px rgba(0,0,0,.08)}
.si{font-size:12px;color:var(--T2);font-weight:500}
/* TOAST */
.toast{position:fixed;top:72px;right:20px;background:var(--P);color:#fff;padding:10px 15px;border-radius:8px;font-size:13px;font-weight:500;z-index:9999;transform:translateX(160%);transition:transform .3s;max-width:290px}
.toast.show{transform:translateX(0)}.toast.ok{background:var(--G)}.toast.er{background:var(--A)}
/* MODAL */
.mo{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:1000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);padding:14px}
.mo.open{display:flex}
.md{background:var(--S);border-radius:14px;box-shadow:0 24px 80px rgba(0,0,0,.3);width:100%;max-width:680px;max-height:90vh;overflow-y:auto;animation:mi .22s ease}
@keyframes mi{from{opacity:0;transform:scale(.95) translateY(12px)}to{opacity:1;transform:none}}
.mh{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--B);position:sticky;top:0;background:var(--S);z-index:2}
.mh h2{font-family:'DM Serif Display',serif;font-size:18px}
.mcl{background:none;border:none;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:15px;background:var(--S2);display:flex;align-items:center;justify-content:center}
.mcl:hover{background:var(--S3)}
.mb{padding:20px}.mf{padding:13px 20px;border-top:1px solid var(--B);display:flex;gap:9px;justify-content:flex-end;flex-wrap:wrap}
.ef{display:flex;flex-direction:column;gap:4px;margin-bottom:12px}
.ef label{font-size:10px;font-weight:600;color:var(--T2);text-transform:uppercase;letter-spacing:.8px}
.ef input,.ef textarea{border:1.5px solid var(--B);border-radius:var(--r);padding:8px 10px;font-family:'DM Sans',sans-serif;font-size:13px;width:100%}
.ef textarea{min-height:100px;resize:vertical}
/* HONORAR */
.hb2{background:var(--P);color:#fff;border-radius:8px;padding:16px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-top:12px}
.cg{display:flex;gap:12px;flex-wrap:wrap}
.cl{display:flex;align-items:center;gap:7px;cursor:pointer;font-size:13px;font-weight:500}
.cl input{width:15px;height:15px;accent-color:var(--A)}
@media(max-width:768px){.fg{grid-template-columns:1fr}.c2{grid-column:span 1}.hdr-in{padding:10px 14px}.main{padding:14px 14px 100px}.lt p{display:none}}

/* CAMERA MODAL (LIVE + FRAME + CROP) */
.camBox{position:relative;width:100%;aspect-ratio:16/10;background:#000;border-radius:12px;overflow:hidden;border:1px solid var(--B)}
#camVideo{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform-origin:center center}
.camMask{position:absolute;inset:0;background:rgba(0,0,0,.35)}
/* frame ratio ~ Fahrzeugschein (ZB I) ‚Äì eher breit */
.camFrame{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
  width:min(92%,520px); aspect-ratio:1.52/1; border:2px solid rgba(255,255,255,.85);
  border-radius:10px; box-shadow:0 0 0 9999px rgba(0,0,0,.38); background:transparent}
.camHint{position:absolute;left:50%;bottom:-26px;transform:translateX(-50%);font-size:11px;color:#fff;opacity:.9;white-space:nowrap}
.camCorner{position:absolute;width:20px;height:20px;border:3px solid #fff;border-radius:3px}
.camCorner.tl{left:-2px;top:-2px;border-right:none;border-bottom:none}
.camCorner.tr{right:-2px;top:-2px;border-left:none;border-bottom:none}
.camCorner.bl{left:-2px;bottom:-2px;border-right:none;border-top:none}
.camCorner.br{right:-2px;bottom:-2px;border-left:none;border-top:none}
.camCtl{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-top:12px}
.camLbl{font-size:12px;font-weight:600;color:var(--T2);text-transform:uppercase;letter-spacing:.8px}
#camZoom{flex:1;min-width:200px}
.camBtns{display:flex;gap:8px;flex-wrap:wrap}
</style>
</head>
<body>
<div class="toast" id="toast"></div>

<header class="hdr">
  <div class="hdr-in">
    <div class="logo">
      <div class="lm">SBO</div>
      <div class="lt">
        <h1>Service B√ºro Oberhavel GmbH</h1>
        <p>KFZ-Sachverst√§ndigenb√ºro ¬∑ Auftragsformular 2025-2.0</p>
      </div>
    </div>
    <div class="ha">
      <button class="btn bs" onclick="resetForm()">‚Ü∫ Neu</button>
      <button class="btn bp" onclick="generatePDF()">‚¨á PDF</button>
      <button class="btn bp" onclick="openFinish()">‚úì Abschlie√üen</button>
    </div>
  </div>
  <div class="pb"><div class="pf" id="pf" style="width:20%"></div></div>
</header>

<nav class="snav">
  <div class="sin">
    <div class="stab active" onclick="goStep(1)" id="t1"><div class="sn">1</div>Scan</div>
    <div class="stab" onclick="goStep(2)" id="t2"><div class="sn">2</div>Auftraggeber</div>
    <div class="stab" onclick="goStep(3)" id="t3"><div class="sn">3</div>Fahrzeugdaten</div>
    <div class="stab" onclick="goStep(4)" id="t4"><div class="sn">4</div>Schaden &amp; Vers.</div>
    <div class="stab" onclick="goStep(5)" id="t5"><div class="sn">5</div>Unterschriften</div>
  </div>
</nav>

<main class="main">

<!-- STEP 1: OCR SCAN -->
<div class="sc2 active" id="s1">
  <!-- API key card: hidden by default, shown automatically if running locally -->
  <div class="card" id="keyCard" style="border-color:#fca5a5">
    <div class="ch" style="background:#fef2f2"><div class="ci" style="background:#dc2626">üîë</div><div class="ct"><h3>API-Key einrichten ‚Äî einmalig</h3><p>Wird nur in Ihrem Browser gespeichert ‚Äî nicht im Code, nicht auf GitHub sichtbar</p></div></div>
    <div class="cb">
      <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap">
        <div class="f" style="flex:1;min-width:260px">
          <label>Anthropic API-Key (sk-ant-‚Ä¶)</label>
          <input type="password" id="apikey" placeholder="sk-ant-api03-‚Ä¶" style="font-family:'JetBrains Mono',monospace;font-size:12px" oninput="saveApiKey()">
        </div>
        <button class="btn bp" onclick="retryOcr()">‚Ü∫ Speichern &amp; scannen</button>
      </div>
      <div style="margin-top:10px;font-size:11px;color:var(--T2);line-height:1.8;background:var(--S2);padding:10px;border-radius:6px">
        <strong>So erhalten Sie Ihren Key:</strong><br>
        1. <strong>console.anthropic.com</strong> √∂ffnen ‚Üí anmelden<br>
        2. Links <strong>"API Keys"</strong> ‚Üí <strong>"Create Key"</strong><br>
        3. Key kopieren und oben einf√ºgen ‚Üí einmalig pro Ger√§t/Browser
      </div>
    </div>
  </div>
  <div class="card">
    <div class="ch"><div class="ci">üì∑</div><div class="ct"><h3>Fahrzeugschein fotografieren ‚Äî KI-Erkennung</h3><p>Felder A, B, 2.1, 2.2, C.1.x, D.1/D.2, E, F.1, G, P.1‚ÄìP.3, S.1, 15.1, 15.2, R werden automatisch erkannt</p></div></div>
    <div class="cb">
      <div class="cz" id="cz" onclick="document.getElementById('cinput').click()">
        <div class="so" id="osp">
          <div class="sp2"></div>
          <div class="stxt" id="spTxt">KI analysiert Fahrzeugschein‚Ä¶</div>
        </div>
        <span class="ci2">ü™™</span>
        <h4>Fahrzeugschein fotografieren oder Datei w√§hlen</h4>
        <p>Klicken ¬∑ Foto aufnehmen oder aus Galerie w√§hlen ¬∑ JPG, PNG, HEIC</p>
        <img id="vip" alt="">
        <input type="file" id="cinput" accept="image/*" style="display:none" onchange="handleImg(event)">
      </div>
      <div class="orbox" id="orbox"><h5>‚úì Erkannte Felder ‚Äî automatisch eingetragen</h5><div class="ofs" id="ofs"></div></div>
      <div class="errbox" id="errbox"><h5>‚ö† Erkennung fehlgeschlagen</h5><p id="errmsg"></p></div>
      <div style="margin-top:14px;display:flex;gap:9px;flex-wrap:wrap">
        <button class="btn bp" onclick="openCam()">üì∏ Live Kamera (Rahmen)</button>
        <button class="btn bs" onclick="document.getElementById('cinput').click()">üñºÔ∏è Bild hochladen</button>
        <button class="btn bo" onclick="goStep(2)">√úberspringen ‚Üí manuell</button>
      </div>
    </div>
  </div>
</div>

<!-- STEP 2: AUFTRAGGEBER -->
<div class="sc2" id="s2">
  <div class="card">
    <div class="ch"><div class="ci">üë§</div><div class="ct"><h3>Fahrzeughalter / Auftraggeber</h3></div></div>
    <div class="cb">
      <div class="fg">
        <div class="f c2"><label><span class="code">C.1.1</span>Name / Firma</label><input type="text" id="f_name" placeholder="Nachname / Firmenname"></div>
        <div class="f"><label><span class="code">C.1.2</span>Vorname</label><input type="text" id="f_vname"></div>
        <div class="f"><label>PLZ</label><input type="text" id="f_plz" maxlength="6" placeholder="12345"></div>
        <div class="f"><label><span class="code">C.1.3</span>Wohnort</label><input type="text" id="f_ort"></div>
        <div class="f c2"><label><span class="code">C.1.3</span>Stra√üe + Nr.</label><input type="text" id="f_str" placeholder="Musterstra√üe 1"></div>
        <div class="f"><label>Telefon</label><input type="tel" id="f_tel" placeholder="+49 ‚Ä¶"></div>
        <div class="f"><label>E-Mail</label><input type="email" id="f_mail" placeholder="name@beispiel.de"></div>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="ch"><div class="ci">üìã</div><div class="ct"><h3>Bevollm√§chtigter Auftraggeber</h3><p>Nur wenn nicht der Fahrzeughalter selbst</p></div></div>
    <div class="cb">
      <div style="margin-bottom:13px"><label class="cl"><input type="checkbox" id="hbev" onchange="tgBev()">Auftrag durch Bevollm√§chtigten</label></div>
      <div id="bevd" style="display:none"><div class="fg">
        <div class="f"><label>Name</label><input type="text" id="b_name"></div>
        <div class="f"><label>Vorname</label><input type="text" id="b_vname"></div>
        <div class="f"><label>PLZ</label><input type="text" id="b_plz"></div>
        <div class="f"><label>Wohnort</label><input type="text" id="b_ort"></div>
        <div class="f c2"><label>Stra√üe</label><input type="text" id="b_str"></div>
        <div class="f"><label>Telefon</label><input type="tel" id="b_tel"></div>
        <div class="f"><label>Sonstiges</label><input type="text" id="b_son"></div>
      </div></div>
    </div>
  </div>
  <div class="card">
    <div class="ch"><div class="ci">üóìÔ∏è</div><div class="ct"><h3>Auftrag &amp; Besichtigung</h3></div></div>
    <div class="cb"><div class="fg">
      <div class="f"><label>Auftragsdatum</label><input type="date" id="f_adat"></div>
      <div class="f"><label>Schadentag</label><input type="date" id="f_sdat"></div>
      <div class="f"><label>Uhrzeit Schaden</label><input type="time" id="f_szeit"></div>
      <div class="f c2">
        <label>Gutachten-Nr. / Schaden-Nr.</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="text" id="f_gnr_prefix" readonly style="max-width:120px;font-family:'JetBrains Mono',monospace;background:var(--S2)" value="">
          <input type="text" id="f_gnr_num" placeholder="Nummer (z.B. 0007)" style="flex:1;font-family:'JetBrains Mono',monospace">
          <input type="hidden" id="f_gnr" value="">
        </div>
      </div>
      <div class="f c2"><label>Besichtigungsort</label><input type="text" id="f_bort"></div>
      <div class="f"><label>Besichtigungs-Uhrzeit</label><input type="time" id="f_bzeit"></div>
      <div class="f"><label>Sonstiges</label><input type="text" id="f_son"></div>
    </div></div>
  </div>
</div>

<!-- STEP 3: FAHRZEUGDATEN -->
<div class="sc2" id="s3">
  <div class="card">
    <div class="ch"><div class="ci">üöó</div><div class="ct"><h3>Fahrzeugdaten</h3><p>Technische Daten aus dem Fahrzeugschein</p></div></div>
    <div class="cb"><div class="fg">
      <div class="f c2"><label><span class="code">A</span>Amtliches Kennzeichen</label><input type="text" id="v_kz" placeholder="OHV-XX 123" style="text-transform:uppercase;font-family:'JetBrains Mono',monospace;letter-spacing:2px;font-size:15px"></div>
      <div class="f"><label><span class="code">2.1</span>Schl√ºsselnr. Typ (HSN)</label><input type="text" id="v_s21" placeholder="0603" style="font-family:'JetBrains Mono',monospace"></div>
      <div class="f"><label><span class="code">2.2</span>Schl√ºsselnr. Var./Ver. (TSN)</label><input type="text" id="v_s22" placeholder="ABB" style="font-family:'JetBrains Mono',monospace"></div>
      <div class="f"><label><span class="code">5</span>Fahrzeug- und Aufbauart</label><input type="text" id="v_auf" placeholder="z.B. Fahrzeugklasse + Aufbau (zweizeilig m√∂glich)"></div>
      <div class="f"><label><span class="code">D.1</span>Hersteller / Marke</label><input type="text" id="v_her" placeholder="Volkswagen"></div>
      <div class="f c2"><label><span class="code">D.2</span>Typ und Ausf√ºhrung</label><input type="text" id="v_typ" placeholder="Golf VII 2.0 TDI Comfortline"></div>
      <div class="f c2"><label><span class="code">E</span>Fahrzeug-Ident.-Nr. (FIN / VIN)</label><input type="text" id="v_vin" placeholder="WVWZZZ‚Ä¶" style="font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:1px"></div>
      <div class="f"><label><span class="code">P.3</span>Antriebsart</label><select id="v_ant"><option value="">Bitte w√§hlen</option><option>Benzin</option><option>Diesel</option><option>Elektro</option><option>Hybrid (Benzin+E)</option><option>Hybrid (Diesel+E)</option><option>Gas (CNG)</option><option>Gas (LPG)</option><option>Wasserstoff</option></select></div>
      <div class="f"><label><span class="code">P.2</span>Leistung (kW)</label><input type="number" id="v_kw" placeholder="110"></div>
      <div class="f"><label><span class="code">P.1</span>Hubraum (cm¬≥)</label><input type="number" id="v_hub" placeholder="1984"></div>
      <div class="f"><label><span class="code">G</span>Leergewicht (kg)</label><input type="number" id="v_lg" placeholder="1350"></div>
      <div class="f"><label><span class="code">F.1</span>Zul. Gesamtgewicht (kg)</label><input type="number" id="v_gg" placeholder="1850"></div>
      <div class="f"><label><span class="code">S.1</span>Sitzpl√§tze</label><input type="number" id="v_sp" placeholder="5"></div>
      <div class="f"><label><span class="code">15.1</span>Reifengr√∂√üe vorn</label><input type="text" id="v_rv" placeholder="205/55R16" style="font-family:'JetBrains Mono',monospace"></div>
      <div class="f"><label><span class="code">15.2</span>Reifengr√∂√üe hinten</label><input type="text" id="v_rh" placeholder="205/55R16" style="font-family:'JetBrains Mono',monospace"></div>
      <div class="f"><label><span class="code">B</span>Erstzulassung</label><input type="date" id="v_ez"></div>
      <div class="f"><label><span class="code">I</span>Letzte Zulassung</label><input type="date" id="v_lz"></div>
      <div class="f"><label><span class="code">R</span>Fahrzeugfarbe</label><input type="text" id="v_farbe" placeholder="Schwarz Metallic"></div>
      <div class="f"><label>Laufleistung (km)</label><input type="number" id="v_km" placeholder="85000"></div>
      <div class="f"><label>T√úV bis</label><input type="month" id="v_tuev"></div>
      <div class="f"><label>AU bis</label><input type="month" id="v_au"></div>
    </div></div>
  </div>
</div>

<!-- STEP 4: SCHADEN & VERSICHERUNG -->
<div class="sc2" id="s4">
  <div class="card">
    <div class="ch"><div class="ci">üè¢</div><div class="ct"><h3>Regulierende Versicherung</h3></div></div>
    <div class="cb">
      <div style="margin-bottom:13px"><div class="cg"><label class="cl"><input type="radio" name="va" value="Haftpflicht" checked>Haftpflicht</label><label class="cl"><input type="radio" name="va" value="Kasko">Kasko</label></div></div>
      <div class="fg">
        <div class="f c2"><label>Versicherung</label><input type="text" id="vs_n" placeholder="DEVK, HUK-Coburg, ADAC ‚Ä¶"></div>
        <div class="f"><label>Versicherungs-Nr.</label><input type="text" id="vs_nr" style="font-family:'JetBrains Mono',monospace"></div>
        <div class="f"><label>Schaden-Nr.</label><input type="text" id="vs_sn" style="font-family:'JetBrains Mono',monospace"></div>
        <div class="f c2"><label>Versicherungsnehmer</label><input type="text" id="vs_nh"></div>
        <div class="f"><label>KZ Unfallgegner</label><input type="text" id="vs_kz" style="font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:2px"></div>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="ch"><div class="ci">‚ùì</div><div class="ct"><h3>Fragen an den Kunden</h3></div></div>
    <div class="cb">
      <div class="qr"><p>Unfall- oder Vorsch√§den vorhanden?</p><div class="tg"><button class="tb" id="q1j" onclick="tog('q1','j')">Ja</button><button class="tb" id="q1n" onclick="tog('q1','n')">Nein</button></div></div>
      <div id="q1d" style="display:none;padding:10px 0;border-bottom:1px solid var(--B);flex-direction:column;gap:9px">
        <div class="f" style="width:100%"><label>Wenn ja, wo?</label><input type="text" id="q1w" placeholder="Beschreibung Vorschaden"></div>
        <div style="display:flex;align-items:center;gap:10px"><span style="font-size:13px;font-weight:500">Vorschaden beseitigt?</span><div class="tg"><button class="tb" id="q2j" onclick="tog('q2','j')">Ja</button><button class="tb" id="q2n" onclick="tog('q2','n')">Nein</button></div></div>
      </div>
      <div class="qr"><p>Vorsteuerabzugsberechtigt?</p><div class="tg"><button class="tb" id="q3j" onclick="tog('q3','j')">Ja</button><button class="tb" id="q3n" onclick="tog('q3','n')">Nein</button></div></div>
      <div class="qr"><p>Soll das Fahrzeug repariert werden?</p><div class="tg"><button class="tb" id="q4j" onclick="tog('q4','j')">Ja</button><button class="tb" id="q4n" onclick="tog('q4','n')">Nein</button></div></div>
      <div class="qr"><p>Abrechnung auf Gutachtenbasis?</p><div class="tg"><button class="tb" id="q5j" onclick="tog('q5','j')">Ja</button><button class="tb" id="q5n" onclick="tog('q5','n')">Nein</button></div></div>
      <div class="qr" style="border-bottom:none"><p>Zahlungsanweisung (Vers. zahlt direkt)</p><div class="tg"><button class="tb" id="q6j" onclick="tog('q6','j')">Ja</button><button class="tb" id="q6n" onclick="tog('q6','n')">Nein</button></div></div>
    </div>
  </div>
  <div class="card">
    <div class="ch"><div class="ci">üí∂</div><div class="ct"><h3>Preisinformationen / SV-Honorar</h3><p>Verg√ºtung gem√§√ü HUK-Honorartableau ‚Äî wird auf die PDF gedruckt</p></div></div>
    <div class="cb">
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:10px">
        <div style="background:var(--P);color:#fff;border-radius:8px;padding:14px">
          <div style="font-size:10px;opacity:.6;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Schadengutachten</div>
          <div style="font-size:14px;font-weight:700">HUK-Honorartableau</div>
          <div style="font-size:11px;opacity:.7;margin-top:3px">gem√§√ü aktueller HUK-Schadenregulierung</div>
        </div>
        <div style="background:var(--S2);border:1px solid var(--B);border-radius:8px;padding:14px">
          <div style="font-size:10px;color:var(--T2);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Fahrzeugwertgutachten</div>
          <div style="font-size:14px;font-weight:700">160,00 ‚Ç¨ netto</div>
          <div style="font-size:11px;color:var(--T2);margin-top:3px">190,40 ‚Ç¨ brutto inkl. MwSt.</div>
        </div>
        <div style="background:var(--S2);border:1px solid var(--B);border-radius:8px;padding:14px">
          <div style="font-size:10px;color:var(--T2);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Kurzgutachten / KVA</div>
          <div style="font-size:14px;font-weight:700">115,00 ‚Ç¨ netto</div>
          <div style="font-size:11px;color:var(--T2);margin-top:3px">136,85 ‚Ç¨ brutto inkl. MwSt.</div>
        </div>
        <div style="background:var(--S2);border:1px solid var(--B);border-radius:8px;padding:14px">
          <div style="font-size:10px;color:var(--T2);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Zeitabrechnung</div>
          <div style="font-size:14px;font-weight:700">165,00 ‚Ç¨ netto/Std</div>
          <div style="font-size:11px;color:var(--T2);margin-top:3px">196,35 ‚Ç¨ brutto inkl. MwSt.</div>
        </div>
        <div style="background:var(--S2);border:1px solid var(--B);border-radius:8px;padding:14px">
          <div style="font-size:10px;color:var(--T2);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Aufwandspauschale</div>
          <div style="font-size:14px;font-weight:700">50,00 ‚Ç¨ netto</div>
          <div style="font-size:11px;color:var(--T2);margin-top:3px">59,50 ‚Ç¨ brutto ¬∑ gem. HUK</div>
        </div>
        <div style="background:var(--S2);border:1px solid var(--B);border-radius:8px;padding:14px">
          <div style="font-size:10px;color:var(--T2);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Fahrtkosten</div>
          <div style="font-size:14px;font-weight:700">2,00 ‚Ç¨ netto/km</div>
          <div style="font-size:11px;color:var(--T2);margin-top:3px">2,83 ‚Ç¨ brutto ¬∑ gem. HUK</div>
        </div>
      </div>
      
      <div style="margin-top:12px;display:flex;gap:9px;flex-wrap:wrap;align-items:center">
        <button class="btn bo" onclick="toggleHuk()">üìÑ HUK-Honorartableau anzeigen</button>
        <span style="font-size:11px;color:var(--T2)">Optional zur Ansicht im Formular</span>
      </div>
      <div id="hukWrap" style="display:none;margin-top:10px;border:1px solid var(--B);border-radius:10px;overflow:hidden">
        <div style="background:var(--S2);padding:10px 12px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div style="font-size:12px;font-weight:600">HUK-Honorartableau (Auszug 500‚Äì30.000 ‚Ç¨)</div>
          <button class="btn bs" onclick="toggleHuk()">Schlie√üen</button>
        </div>
        <div style="max-height:260px;overflow:auto;background:#fff">
          <table style="width:100%;border-collapse:collapse;font-size:12px">
            <thead>
              <tr style="background:var(--S3);text-align:left">
                <th style="padding:8px 10px;border-bottom:1px solid var(--B)">Schadenh√∂he bis (‚Ç¨)</th>
                <th style="padding:8px 10px;border-bottom:1px solid var(--B)">Brutto (‚Ç¨)</th>
                <th style="padding:8px 10px;border-bottom:1px solid var(--B)">Netto (‚Ç¨)</th>
              </tr>
            </thead>
            <tbody id="hukBody"></tbody>
          </table>
        </div>
      </div>
<div style="margin-top:12px;font-size:11px;color:var(--T2);background:var(--S2);border-radius:6px;padding:10px;line-height:1.6">
        ‚ÑπÔ∏è Das vollst√§ndige HUK-Honorartableau (500 ‚Ç¨‚Äì30.000 ‚Ç¨ Schadenh√∂he) wird auf Seite 2 der PDF gedruckt.
      </div>
    </div>
  </div>
</div>

<!-- STEP 5: UNTERSCHRIFTEN -->
<div class="sc2" id="s5">
  <div class="card">
    <div class="ch"><div class="ci">‚úçÔ∏è</div><div class="ct"><h3>Unterschrift 1 ‚Äî Auftragserteilung</h3></div></div>
    <div class="cb">
      <div style="background:var(--S2);border:1px solid var(--B);border-radius:8px;padding:12px;margin-bottom:14px;font-size:11px;line-height:1.7;color:var(--T2)">Mit meiner Unterschrift erteile ich den Auftrag zur Erstellung eines Gutachtens und erkl√§re, dass ich den Auftrag / Vertrag gelesen habe und f√ºr die vollst√§ndige Begleichung der Rechnung allein verantwortlich bin. Ich erkl√§re mich mit der Digitalisierung meiner Unterschrift einverstanden.</div>
      <div class="sc"><canvas id="sg1" width="900" height="200"></canvas><div class="sl"><div class="sli"></div><span>Unterschrift Auftraggeber</span><div class="sli"></div></div></div>
      <div class="sa"><button class="btn bo" onclick="clrSig(1)">‚úï L√∂schen</button><div class="ss" id="ss1">Noch nicht unterschrieben</div></div>
    </div>
  </div>
  <div class="card">
    <div class="ch"><div class="ci">üí≥</div><div class="ct"><h3>Unterschrift 2 ‚Äî Zahlungsanweisung</h3></div></div>
    <div class="cb">
      <div style="background:var(--S2);border:1px solid var(--B);border-radius:8px;padding:12px;margin-bottom:14px;font-size:11px;line-height:1.7;color:var(--T2)">Der Auftraggeber weist das Versicherungsunternehmen unwiderruflich an, den Rechnungsbetrag in ungek√ºrzter H√∂he des Bruttobetrages direkt an die SBO Service B√ºro Oberhavel GmbH zu zahlen.</div>
      <div class="sc"><canvas id="sg2" width="900" height="200"></canvas><div class="sl"><div class="sli"></div><span>Unterschrift Zahlungsanweisung</span><div class="sli"></div></div></div>
      <div class="sa"><button class="btn bo" onclick="clrSig(2)">‚úï L√∂schen</button><div class="ss" id="ss2">Noch nicht unterschrieben</div></div>
    </div>
  </div>
  <div class="card">
    <div class="ch"><div class="ci">üìä</div><div class="ct"><h3>Unterschrift 3 ‚Äî Honorarvereinbarung</h3></div></div>
    <div class="cb">
      <div style="background:var(--S2);border:1px solid var(--B);border-radius:8px;padding:12px;margin-bottom:14px;font-size:11px;line-height:1.7;color:var(--T2)">Mit meiner Unterschrift stimme ich dem SV-Honorartableau gem√§√ü HUK-Schadenregulierung unwiderruflich zu.</div>
      <div class="sc"><canvas id="sg3" width="900" height="200"></canvas><div class="sl"><div class="sli"></div><span>Unterschrift Honorarvereinbarung</span><div class="sli"></div></div></div>
      <div class="sa"><button class="btn bo" onclick="clrSig(3)">‚úï L√∂schen</button><div class="ss" id="ss3">Noch nicht unterschrieben</div></div>
    </div>
  </div>
  <div style="display:flex;gap:9px;flex-wrap:wrap;margin-top:4px">
    <button class="btn bg2" onclick="openFinish()" style="font-size:14px;padding:12px 24px">‚úì Auftrag abschlie√üen &amp; E-Mail</button>
    <button class="btn bp" onclick="generatePDF()">‚¨á PDF herunterladen</button>
  </div>
</div>

</main>

<div class="bn">
  <button class="btn bo" id="bprev" onclick="prevStep()" style="display:none">‚Üê Zur√ºck</button>
  <div class="si" id="sind">Schritt 1 von 5</div>
  <button class="btn bp" id="bnext" onclick="nextStep()">Weiter ‚Üí</button>
</div>


<!-- CAMERA MODAL -->
<div class="mo" id="mcam">
  <div class="md">
    <div class="mh">
      <h2>üì∏ Fahrzeugschein scannen</h2>
      <button class="mcl" onclick="closeCam()">‚úï</button>
    </div>
    <div class="mb">
      <div class="camBox">
        <video id="camVideo" playsinline autoplay muted></video>
        <div class="camMask"></div>
        <div class="camFrame" id="camFrame">
          <div class="camCorner tl"></div><div class="camCorner tr"></div>
          <div class="camCorner bl"></div><div class="camCorner br"></div>
          <div class="camHint">Schein in den Rahmen ¬∑ Zoom nutzen ¬∑ dann Foto</div>
        </div>
      </div>

      <div class="camCtl">
        <label class="camLbl">Zoom</label>
        <input id="camZoom" type="range" min="1" max="3" step="0.05" value="1" oninput="setCamZoom(this.value)">
        <div class="camBtns">
          <button class="btn bo" onclick="switchCam()">‚Üª Kamera wechseln</button>
          <button class="btn bg2" onclick="snapCam()">üì∑ Foto &amp; scannen</button>
        </div>
      </div>

      <div style="margin-top:10px;font-size:11px;color:var(--T2);line-height:1.6">
        ‚ÑπÔ∏è Tipp: Gute Beleuchtung, Schein plan hinlegen, keine Reflexionen. Kamera braucht <b>HTTPS</b>.
      </div>
    </div>
  </div>
</div>

<!-- FINISH MODAL -->
<div class="mo" id="mfin">
  <div class="md">
    <div class="mh"><h2>‚úì Auftrag abschlie√üen</h2><button class="mcl" onclick="closeMo('mfin')">‚úï</button></div>
    <div class="mb">
      <div style="background:#f0fdf4;border:1px solid #86efac;border-radius:8px;padding:13px;margin-bottom:18px;display:flex;align-items:center;gap:11px">
        <span style="font-size:24px">‚úÖ</span>
        <div><div style="font-weight:600;font-size:14px;color:var(--G)">Auftrag erfasst!</div><div style="font-size:12px;color:var(--T2);margin-top:2px" id="fsl">‚Äî</div></div>
      </div>
      <h3 style="font-size:13px;font-weight:600;margin-bottom:13px;display:flex;align-items:center;gap:7px"><span style="background:#2563eb;color:#fff;padding:3px 7px;border-radius:4px;font-size:10px">@</span>Per E-Mail versenden</h3>
      <div class="ef"><label>An</label><input type="email" id="eto" placeholder="kunde@beispiel.de"></div>
      <div class="ef"><label>CC</label><input type="email" id="ecc" value="info@ohv-service.de"></div>
      <div class="ef"><label>Betreff</label><input type="text" id="esub"></div>
      <div class="ef"><label>Nachricht</label><textarea id="ebody"></textarea></div>
      <div style="background:var(--S2);border:1px solid var(--B);border-radius:8px;padding:10px;font-size:11px;color:var(--T2)">‚ÑπÔ∏è √ñffnet Ihr Standard-E-Mail-Programm. PDF separat als Anhang hinzuf√ºgen.</div>
    </div>
    <div class="mf">
      <button class="btn bo" onclick="closeMo('mfin')">Schlie√üen</button>
      <button class="btn bp" onclick="closeMo('mfin');generatePDF()">‚¨á PDF</button>
      <button class="btn bbl" onclick="sendMail()">üìß E-Mail √∂ffnen</button>
    </div>
  </div>
</div>

<script>
// ================================================================
// HONORAR TABLE
// ================================================================
const HT=[[500,368.90,310],[750,413.53,347.50],[1000,506.35,425.50],[1250,571.20,480],[1500,617.02,518.50],[1750,654.50,550],[2000,690.20,580],[2250,721.14,606],[2500,751.49,631.50],[2750,781.24,656.50],[3000,808.61,679.50],[3250,834.79,701.50],[3500,861.56,724],[3750,888.93,747],[4000,915.71,769.50],[4250,940.10,790],[4500,965.69,811.50],[4750,986.51,829],[5000,1009.12,848],[5500,1056.13,887.50],[6000,1100.16,924.50],[6500,1133.48,952.50],[7000,1165.61,979.50],[7500,1197.14,1006],[8000,1235.82,1038.50],[8500,1273.30,1070],[9000,1311.38,1102],[9500,1346.49,1131.50],[10000,1383.97,1163],[11000,1457.75,1225],[12000,1534.51,1289.50],[13000,1613.64,1356],[14000,1686.83,1417.50],[15000,1765.37,1483.50],[16000,1824.87,1533.50],[17000,1889.72,1588],[18000,1949.82,1638.50],[19000,2021.22,1698.50],[20000,2089.64,1756],[21000,2164.61,1819],[22000,2231.25,1875],[23000,2295.51,1929],[24000,2363.34,1986],[25000,2415.11,2029.50],[26000,2483.53,2087],[27000,2551.36,2144],[28000,2625.14,2206],[29000,2695.35,2265],[30000,2777.46,2334]];

// ================================================================
// NAVIGATION
// ================================================================
let cur=1;
function goStep(n){
  document.getElementById('s'+cur).classList.remove('active');
  const pt=document.getElementById('t'+cur);pt.classList.remove('active');
  if(n>cur)pt.classList.add('done');else pt.classList.remove('done');
  cur=n;
  document.getElementById('s'+n).classList.add('active');
  const ct=document.getElementById('t'+n);ct.classList.add('active');ct.classList.remove('done');
  updNav();window.scrollTo({top:0,behavior:'smooth'});
}
function nextStep(){if(cur<5)goStep(cur+1);}
function prevStep(){if(cur>1)goStep(cur-1);}
function updNav(){
  document.getElementById('sind').textContent='Schritt '+cur+' von 5';
  document.getElementById('bprev').style.display=cur>1?'flex':'none';
  document.getElementById('bnext').style.display=cur<5?'flex':'none';
  document.getElementById('pf').style.width=(cur/5*100)+'%';
}

// ================================================================
// OCR / IMAGE UPLOAD
// ================================================================
function handleImg(e){
  const f=e.target.files[0];if(!f)return;
  document.getElementById('orbox').style.display='none';
  document.getElementById('errbox').style.display='none';
  document.getElementById('osp').style.display='flex';
  document.getElementById('spTxt').textContent='Bild wird komprimiert‚Ä¶';

  // Compress image before sending ‚Äî max 1200px, quality 0.82
  const img=new Image();
  const objUrl=URL.createObjectURL(f);
  img.onload=()=>{
    URL.revokeObjectURL(objUrl);
    const MAX=1200;
    let w=img.width,h=img.height;
    if(w>MAX||h>MAX){const s=Math.min(MAX/w,MAX/h);w=Math.round(w*s);h=Math.round(h*s);}
    const canvas=document.createElement('canvas');
    canvas.width=w;canvas.height=h;
    canvas.getContext('2d').drawImage(img,0,0,w,h);
    const dataUrl=canvas.toDataURL('image/jpeg',0.82);
    const b64=dataUrl.split(',')[1];
    window._lastB64=b64;window._lastMime='image/jpeg';
    document.getElementById('vip').src=dataUrl;
    document.getElementById('vip').style.display='block';
    document.getElementById('cz').classList.add('hi');
    runOCR(b64,'image/jpeg');
  };
  img.onerror=()=>{
    // Fallback: read as-is
    const reader=new FileReader();
    reader.onload=ev=>{
      const dataUrl=ev.target.result;
      const b64=dataUrl.split(',')[1];
      const mime=f.type||'image/jpeg';
      window._lastB64=b64;window._lastMime=mime;
      document.getElementById('vip').src=dataUrl;
      document.getElementById('vip').style.display='block';
      document.getElementById('cz').classList.add('hi');
      runOCR(b64,mime);
    };
    reader.readAsDataURL(f);
  };
  img.src=objUrl;
}

function _AKEY(){
  try{return localStorage.getItem('sbo_akey')||'';}catch(e){return '';}
}
function _saveKey(k){
  try{localStorage.setItem('sbo_akey',k);}catch(e){}
}

const _PROMPT=`Extrahiere folgende Felder aus diesem deutschen Fahrzeugschein (Zulassungsbescheinigung Teil I).
WICHTIG: Nutze ausschlie√ülich die kleinen Feldnummern-K√§stchen (A, B, 2.1, 2.2, C.1.x, D.1, D.2, E, F.1, G, P.1‚ÄìP.3, S.1, 5, R, 15.1, 15.2).
NICHT raten. Wenn ein Feld nicht eindeutig lesbar ist: null.

REGELN
- Werte stehen direkt neben/unter der jeweiligen Feldnummer.
- Feld 5 ist h√§ufig ZWEIZEILIG: beide Zeilen in EINEM String mit Leerzeichen zusammenf√ºhren.
- Feld J (Fahrzeugklasse) NICHT mit Feld 5 verwechseln. F√ºr Feld 5 nur das K√§stchen mit der Nummer 5 verwenden.
- D.2 ist Typ/Variante/Version (kein VIN).
- E ist FIN/VIN (typisch 17 Zeichen A-Z/0-9, ohne I/O/Q). Wenn unsicher: null.
- G ist Masse des in Betrieb befindlichen Fahrzeugs (Leergewicht) in kg, NICHT F.1/F.2.
- P.2 ist Nennleistung in kW (nur Zahl).
- 15.1/15.2 sind Reifengr√∂√üen (z.B. 205/55R16 91V). Wenn nur eine Reifengr√∂√üe vorhanden ist, trage sie in beide Felder ein.

FELDER
A  = kennzeichen
B  = erstzulassung (Datum) -> Ausgabe als YYYY-MM-DD
2.1 = schluessel21 (HSN, 4-stellig)
2.2 = schluessel22 (TSN, alphanumerisch)
C.1.1 = name (Name/Firma)
C.1.2 = vorname
C.1.3 = strasse+plz+ort -> teile in strasse / plz / ort auf
D.1 = hersteller / Marke
D.2 = typ / Variante / Version
E  = vin (FIN/VIN)
F.1 = gesamtgewicht (zul. Gesamtmasse) in kg
G  = leergewicht in kg
P.1 = hubraum in cm3 (nur Zahl)
P.2 = kw (nur Zahl)
P.3 = antrieb (Kraftstoffart)
S.1 = sitzplaetze (nur Zahl)
5  = aufbauart (Bezeichnung der Fahrzeugklasse UND des Aufbaus, zweizeilig m√∂glich)
R  = farbe
15.1 = reifen_v
15.2 = reifen_h

Gib NUR dieses JSON zur√ºck, null wenn nicht lesbar:
{"kennzeichen":null,"erstzulassung":null,"schluessel21":null,"schluessel22":null,"name":null,"vorname":null,"plz":null,"ort":null,"strasse":null,"hersteller":null,"typ":null,"vin":null,"gesamtgewicht":null,"leergewicht":null,"kw":null,"hubraum":null,"antrieb":null,"sitzplaetze":null,"aufbauart":null,"farbe":null,"reifen_v":null,"reifen_h":null}`;

function _fetchT(url,opts,ms){
  const c=new AbortController();
  const t=setTimeout(()=>c.abort(),ms);
  return fetch(url,{...opts,signal:c.signal}).finally(()=>clearTimeout(t));
}

async function runOCR(b64,mime){
  const spinner=document.getElementById('osp');
  const spTxt=document.getElementById('spTxt');
  spinner.style.display='flex';

  const reqBody=JSON.stringify({
    model:'claude-sonnet-4-20250514',max_tokens:900,
    messages:[{role:'user',content:[
      {type:'image',source:{type:'base64',media_type:mime,data:b64}},
      {type:'text',text:_PROMPT}
    ]}]
  });

  try{
    let data=null;
    spTxt.textContent='KI analysiert‚Ä¶';

    // Key pr√ºfen ‚Äî NACH dem Spinner zeigen damit Nutzer Feedback sieht
    const key=_AKEY();
    if(!key){
      spinner.style.display='none';
      const kc=document.getElementById('keyCard');
      if(kc){ kc.style.display='block'; kc.scrollIntoView({behavior:'smooth'}); }
      showOcrErr('Bitte zuerst den API-Key eingeben und auf "Speichern & scannen" klicken.');
      return;
    }
    const r=await _fetchT('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'x-api-key':key,
        'anthropic-version':'2023-06-01',
        'anthropic-dangerous-direct-browser-access':'true'
      },
      body:reqBody
    },30000);
    if(!r.ok){
      let m='';try{const ed=await r.json();m=ed.error?.message||'';}catch(ex){}
      // 401 = ung√ºltiger Key ‚Üí keyCard zeigen
      if(r.status===401){
        const kc=document.getElementById('keyCard');if(kc)kc.style.display='block';
        _saveKey(''); // Key l√∂schen
      }
      throw new Error('API '+r.status+(m?' - '+m:''));
    }
    data=await r.json();

    spinner.style.display='none';
    if(data.error)throw new Error(data.error.message);
    const raw=(data.content&&data.content[0]&&data.content[0].text)||'';
    const match=raw.replace(/```json|```/g,'').trim().match(/\{[\s\S]*\}/);
    if(!match)throw new Error('Kein JSON in Antwort');
    fillOcr(normalizeOcr(JSON.parse(match[0])));

  }catch(err){
    spinner.style.display='none';
    if(err.name==='AbortError'){
      showOcrErr('Zeit√ºberschreitung - bitte nochmal versuchen.');
    } else {
      showOcrErr('Fehler: '+err.message+'\nBitte Felder manuell ausfullen.');
    }
  }
}
function showOcrErr(msg){
  document.getElementById('errmsg').textContent=msg;
  document.getElementById('errbox').style.display='block';
  toast('Scan fehlgeschlagen','er');
}



// ================================================================
// SCHADENNUMMER / GUTACHTEN-NR. (DDMMYYK-<NR>)
// ================================================================
function _ddmmyyFromDateInput(){
  const v=(document.getElementById('f_adat')?.value||'').trim();
  if(!v){ // fallback: today
    const d=new Date();
    const dd=String(d.getDate()).padStart(2,'0');
    const mm=String(d.getMonth()+1).padStart(2,'0');
    const yy=String(d.getFullYear()).slice(-2);
    return dd+mm+yy;
  }
  const p=v.split('-'); // YYYY-MM-DD
  if(p.length!==3)return '';
  return p[2].padStart(2,'0')+p[1].padStart(2,'0')+String(p[0]).slice(-2);
}
function updateGnr(){
  const prefEl=document.getElementById('f_gnr_prefix');
  const numEl=document.getElementById('f_gnr_num');
  const hidden=document.getElementById('f_gnr');
  if(!prefEl||!numEl||!hidden) return;
  const prefix=_ddmmyyFromDateInput()+'K-';
  prefEl.value=prefix;
  let raw=(numEl.value||'').toString().replace(/[^\d]/g,'');
  numEl.value=raw;
  hidden.value=prefix+(raw?raw:'');
}
function initGnr(){
  const ad=document.getElementById('f_adat');
  const num=document.getElementById('f_gnr_num');
  if(ad) ad.addEventListener('change', updateGnr);
  if(num){
    num.addEventListener('input', updateGnr);
    num.addEventListener('focus', ()=>{ updateGnr(); });
  }
  setTimeout(updateGnr, 60);
}


// ================================================================
// HUK-HONORARTABLEAU TOGGLE (VIEW ONLY)
// ================================================================
let _hukBuilt=false;
function toggleHuk(){
  const w=document.getElementById('hukWrap'); if(!w) return;
  const isOpen = w.style.display==='block';
  w.style.display = isOpen ? 'none' : 'block';
  if(!isOpen && !_hukBuilt){
    const tb=document.getElementById('hukBody'); if(!tb) return;
    tb.innerHTML='';
    for(const r of HT){
      const tr=document.createElement('tr');
      tr.innerHTML=
        '<td style="padding:8px 10px;border-bottom:1px solid #eee">'+r[0]+'</td>'+
        '<td style="padding:8px 10px;border-bottom:1px solid #eee">'+Number(r[1]).toFixed(2).replace('.',',')+'</td>'+
        '<td style="padding:8px 10px;border-bottom:1px solid #eee">'+Number(r[2]).toFixed(2).replace('.',',')+'</td>';
      tb.appendChild(tr);
    }
    _hukBuilt=true;
  }
}

// ================================================================
// LIVE CAMERA: FRAME (CARD RATIO) + ZOOM + CROP TO FRAME
// ================================================================
let _camStream=null;
let _camFacing='environment';
async async function openCam(){
  try{
    // Mobile browsers require HTTPS for camera access
    if(!(window.isSecureContext || location.hostname==='localhost' || location.hostname==='127.0.0.1')){
      toast('Kamera braucht HTTPS (oder localhost). Bitte √ºber deine Netlify-URL √∂ffnen.','er');
      return;
    }
    document.getElementById('mcam').classList.add('open');
    await startCam();
  }catch(e){
    toast('Kamera nicht verf√ºgbar: '+(e.message||e),'er');
  }
}
function closeCam(){
  stopCam();
  document.getElementById('mcam').classList.remove('open');
}
async function startCam(){
  stopCam();
  const v=document.getElementById('camVideo');
  const constraints = {
    audio:false,
    video:{
      facingMode: {ideal: _camFacing},
      width:{ideal:1920},
      height:{ideal:1080}
    }
  };
  _camStream = await navigator.mediaDevices.getUserMedia(constraints);
  v.srcObject=_camStream;
  await v.play();
  setCamZoom(document.getElementById('camZoom')?.value||1);
}
function stopCam(){
  const v=document.getElementById('camVideo');
  if(v){ try{v.pause();}catch(e){} v.srcObject=null; }
  if(_camStream){
    _camStream.getTracks().forEach(t=>t.stop());
    _camStream=null;
  }
}
async function switchCam(){
  _camFacing = (_camFacing==='environment') ? 'user' : 'environment';
  await startCam();
}
function setCamZoom(z){
  const v=document.getElementById('camVideo');
  if(!v) return;
  const zz=Math.max(1, Math.min(3, parseFloat(z)||1));
  v.style.transform='scale('+zz+')';
}
function snapCam(){
  const v=document.getElementById('camVideo');
  const f=document.getElementById('camFrame');
  if(!v || !f || !v.videoWidth){ toast('Kamera noch nicht bereit.','er'); return; }

  const vr=v.getBoundingClientRect();
  const fr=f.getBoundingClientRect();

  // Map frame rect (screen) to video pixels using current displayed rect
  const sx = (fr.left - vr.left) / vr.width * v.videoWidth;
  const sy = (fr.top  - vr.top ) / vr.height * v.videoHeight;
  const sw = fr.width / vr.width * v.videoWidth;
  const sh = fr.height/ vr.height * v.videoHeight;

  // clamp
  const csx=Math.max(0, Math.min(v.videoWidth-1, sx));
  const csy=Math.max(0, Math.min(v.videoHeight-1, sy));
  const csw=Math.max(1, Math.min(v.videoWidth-csx, sw));
  const csh=Math.max(1, Math.min(v.videoHeight-csy, sh));

  const canvas=document.createElement('canvas');
  // output size: keep decent resolution for OCR, max 1400px on long edge
  const maxOut=1400;
  let ow=csw, oh=csh;
  const scale=Math.min(1, maxOut/Math.max(ow,oh));
  canvas.width=Math.round(ow*scale);
  canvas.height=Math.round(oh*scale);
  const ctx=canvas.getContext('2d');
  ctx.drawImage(v, csx, csy, csw, csh, 0, 0, canvas.width, canvas.height);

  const dataUrl=canvas.toDataURL('image/jpeg',0.88);
  const b64=dataUrl.split(',')[1];

  // show preview in scan card + run OCR
  document.getElementById('vip').src=dataUrl;
  document.getElementById('vip').style.display='block';
  document.getElementById('cz').classList.add('hi');
  closeCam();
  runOCR(b64,'image/jpeg');
}

function saveApiKey(){
  const k=document.getElementById('apikey').value.trim();
  if(k)_saveKey(k);
}
function retryOcr(){
  const k=document.getElementById('apikey').value.trim();
  if(!k){toast('Bitte API-Key eingeben','er');return;}
  _saveKey(k);
  // Hide keyCard after saving
  const kc=document.getElementById('keyCard');
  if(kc)kc.style.display='none';
  toast('Key gespeichert ‚úì Jetzt Foto w√§hlen','ok');
  // re-trigger with last image if exists, else open file picker
  if(window._lastB64&&window._lastMime){
    runOCR(window._lastB64,window._lastMime);
  } else {
    document.getElementById('cinput').click();
  }
}


function normalizeOcr(d){
  d = d && typeof d==='object' ? {...d} : {};
  const normStr = (v)=> (v===null||v===undefined) ? null : String(v).replace(/\s+/g,' ').trim();
  // Basic trims
  for(const k of Object.keys(d)) d[k]=normStr(d[k]);

  // Date B: accept DD.MM.YYYY or DD.MM.YY
  if(d.erstzulassung){
    const v=d.erstzulassung;
    const m=v.match(/^(\d{1,2})[\.\-/](\d{1,2})[\.\-/](\d{2,4})$/);
    if(m){
      let dd=m[1].padStart(2,'0'), mm=m[2].padStart(2,'0'), yy=m[3];
      if(yy.length===2) yy = (parseInt(yy,10) > 50 ? '19':'20') + yy;
      d.erstzulassung = `${yy}-${mm}-${dd}`;
    }
  }

  // VIN: soft clean, keep only A-Z0-9, uppercase; require length 17 to accept
  const vinClean = (v)=> (v||'').toUpperCase().replace(/[^A-Z0-9]/g,'');
  if(d.vin){
    let v=vinClean(d.vin);
    // sometimes leading stray char -> if 18 and first is I/L, drop
    if(v.length===18 && /^[IL]/.test(v)) v=v.slice(1);
    if(v.length!==17) d.vin=null; else d.vin=v;
  }

  // Numeric helpers
  const toInt = (v)=>{ const n=parseInt(String(v||'').replace(/[^\d]/g,''),10); return Number.isFinite(n)?n:null; };

  // kW plausibility
  if(d.kw!==null){
    const kw=toInt(d.kw);
    d.kw = (kw && kw>=5 && kw<=700) ? String(kw) : null;
  }

  // weights plausibility
  const f1=toInt(d.gesamtgewicht);
  const g=toInt(d.leergewicht);
  if(d.gesamtgewicht!==null) d.gesamtgewicht = f1? String(f1): null;
  if(d.leergewicht!==null) d.leergewicht = g? String(g): null;
  // if G > F.1 then likely swapped -> clear G (better than wrong)
  if(f1 && g && g>f1) d.leergewicht = null;

  // hubraum
  if(d.hubraum!==null){
    const h=toInt(d.hubraum);
    d.hubraum = (h && h>=0 && h<=10000) ? String(h) : null;
  }

  // Sitzpl√§tze
  if(d.sitzplaetze!==null){
    const s=toInt(d.sitzplaetze);
    d.sitzplaetze = (s && s>=1 && s<=99) ? String(s) : null;
  }

  // Aufbauart: collapse newlines, filter out short class codes like M1, N1, AC, M1G
  if(d.aufbauart){
    let a=String(d.aufbauart).replace(/\s*\n+\s*/g,' ').trim();
    if(/^[A-Z0-9]{1,4}$/.test(a.replace(/\s+/g,''))) a=null;
    d.aufbauart=a;
  }

  // Tires: basic pattern
  const normTire=(v)=>{
    v=normStr(v);
    if(!v) return null;
    // common pattern 205/55R16 91V
    const ok = v.match(/\d{3}\s*\/\s*\d{2}\s*R\s*\d{2}(?:\s*\d{2,3}\s*[A-Z])?/i);
    return ok ? v.replace(/\s+/g,' ').toUpperCase() : v.toUpperCase();
  };
  d.reifen_v = normTire(d.reifen_v);
  d.reifen_h = normTire(d.reifen_h);
  if(d.reifen_v && !d.reifen_h) d.reifen_h=d.reifen_v;
  if(d.reifen_h && !d.reifen_v) d.reifen_v=d.reifen_h;

  return d;
}

function fillOcr(d){
  const map={
    kennzeichen:'v_kz',erstzulassung:'v_ez',schluessel21:'v_s21',schluessel22:'v_s22',
    name:'f_name',vorname:'f_vname',plz:'f_plz',ort:'f_ort',strasse:'f_str',
    hersteller:'v_her',typ:'v_typ',vin:'v_vin',gesamtgewicht:'v_gg',leergewicht:'v_lg',
    kw:'v_kw',hubraum:'v_hub',antrieb:'v_ant',sitzplaetze:'v_sp',aufbauart:'v_auf',
    farbe:'v_farbe',reifen_v:'v_rv',reifen_h:'v_rh'
  };
  const tagsEl=document.getElementById('ofs');tagsEl.innerHTML='';let count=0;
  for(const[key,fid]of Object.entries(map)){
    const val=d[key];
    if(val===null||val===undefined||String(val).trim()==='')continue;
    const el=document.getElementById(fid);if(!el)continue;
    const v=String(val).trim();
    if(el.tagName==='SELECT'){
      const lv=v.toLowerCase();
      for(const o of el.options){if(o.text.toLowerCase().includes(lv.split(' ')[0])){el.value=o.value;break;}}
    } else {
      el.value=v;
    }
    el.classList.add('af');setTimeout(()=>el.classList.remove('af'),2500);
    const tag=document.createElement('span');tag.className='ot';
    tag.textContent=key+': '+v;tagsEl.appendChild(tag);count++;
  }
  if(count>0){
    document.getElementById('orbox').style.display='block';
    toast('‚úì '+count+' Felder erkannt und eingetragen!','ok');
  } else {
    showOcrErr('Keine Felder erkannt. Bildqualit√§t verbessern oder manuell ausf√ºllen.');
  }
}

// ================================================================
// FORM HELPERS
// ================================================================
function g(id){const e=document.getElementById(id);return e?(e.value||'').trim():'';}
function dFmt(id){const v=g(id);if(!v)return '';const p=v.split('-');return p.length===3?p[2]+'.'+p[1]+'.'+p[0]:v;}
function tog(id,v){
  document.getElementById(id+'j').className='tb'+(v==='j'?' ay':'');
  document.getElementById(id+'n').className='tb'+(v==='n'?' an':'');
  if(id==='q1')document.getElementById('q1d').style.display=v==='j'?'flex':'none';
}
function tgBev(){document.getElementById('bevd').style.display=document.getElementById('hbev').checked?'block':'none';}
function qv(id){return document.getElementById(id+'j').classList.contains('ay')?'Ja':'Nein';}
function calcH(){
  const s=parseFloat(g('sch')),art=g('art');
  const rd=document.getElementById('hres');rd.style.display='block';
  const b=document.getElementById('hbrutto'),n=document.getElementById('hnetto');
  if(art==='wert'){b.textContent='190,40 ‚Ç¨';n.textContent='160,00 ‚Ç¨';return;}
  if(art==='kurz'){b.textContent='136,85 ‚Ç¨';n.textContent='115,00 ‚Ç¨';return;}
  if(art==='zeit'){b.textContent='196,35 ‚Ç¨/Std';n.textContent='165,00 ‚Ç¨/Std';return;}
  if(!s||s<=0){rd.style.display='none';return;}
  let row=HT[HT.length-1];for(const r of HT){if(s<=r[0]){row=r;break;}}
  b.textContent=row[1].toFixed(2).replace('.',',')+' ‚Ç¨';
  n.textContent=row[2].toFixed(2).replace('.',',')+' ‚Ç¨';
}

// ================================================================
// SIGNATURE PADS
// ================================================================
function initSig(n){
  const c=document.getElementById('sg'+n);if(!c)return;
  const ctx=c.getContext('2d');let dw=false,sgd=false;
  ctx.strokeStyle='#1a1a2e';ctx.lineWidth=2.5;ctx.lineCap='round';ctx.lineJoin='round';
  function pos(e){
    const r=c.getBoundingClientRect();
    const sx=c.width/r.width,sy=c.height/r.height;
    const s=e.touches?e.touches[0]:e;
    return{x:(s.clientX-r.left)*sx,y:(s.clientY-r.top)*sy};
  }
  function start(e){e.preventDefault();dw=true;const p=pos(e);ctx.beginPath();ctx.moveTo(p.x,p.y);}
  function move(e){
    e.preventDefault();if(!dw)return;
    const p=pos(e);ctx.lineTo(p.x,p.y);ctx.stroke();
    if(!sgd){sgd=true;const s=document.getElementById('ss'+n);s.textContent='‚úì Unterschrieben';s.classList.add('ok');}
  }
  function end(e){e.preventDefault();dw=false;ctx.beginPath();}
  c.addEventListener('mousedown',start);c.addEventListener('mousemove',move);
  c.addEventListener('mouseup',end);c.addEventListener('mouseleave',end);
  c.addEventListener('touchstart',start,{passive:false});
  c.addEventListener('touchmove',move,{passive:false});
  c.addEventListener('touchend',end);
}
function clrSig(n){
  const c=document.getElementById('sg'+n);
  c.getContext('2d').clearRect(0,0,c.width,c.height);
  const s=document.getElementById('ss'+n);s.textContent='Noch nicht unterschrieben';s.classList.remove('ok');
}

// Check if a signature canvas has content
function hasSig(n){
  const c=document.getElementById('sg'+n);if(!c)return false;
  const d=c.getContext('2d').getImageData(0,0,c.width,c.height).data;
  for(let i=3;i<d.length;i+=4)if(d[i]>10)return true;
  return false;
}
// Returns PNG with WHITE background so dark ink is visible in PDF
function getSigPNG(n){
  if(!hasSig(n))return null;
  const src=document.getElementById('sg'+n);
  const off=document.createElement('canvas');
  off.width=src.width;off.height=src.height;
  const ctx=off.getContext('2d');
  ctx.fillStyle='#ffffff';
  ctx.fillRect(0,0,off.width,off.height);
  ctx.drawImage(src,0,0);
  return off.toDataURL('image/png');
}

// ================================================================
// MODAL
// ================================================================
function closeMo(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.mo').forEach(el=>el.addEventListener('click',function(e){
  if(e.target!==this) return;
  if(this.id==='mcam') closeCam(); else closeMo(this.id);
}));

function openFinish(){
  const nm=[g('f_name'),g('f_vname')].filter(Boolean).join(' ')||'Auftraggeber';
  const kz=g('v_kz')||'‚Äî';const dat=dFmt('f_adat');
  document.getElementById('fsl').textContent=nm+' ¬∑ Kz: '+kz+' ¬∑ '+dat;
  document.getElementById('eto').value=g('f_mail');
  document.getElementById('esub').value='Auftragsbest√§tigung SBO ‚Äì '+kz+' ‚Äì '+dat;
  document.getElementById('ebody').value=
    'Sehr geehrte/r '+nm+',\n\n'+
    'hiermit best√§tigen wir Ihren Auftrag zur Erstellung eines Kfz-Schadengutachtens.\n\n'+
    'Fahrzeug: '+g('v_her')+' '+g('v_typ')+'\nKennzeichen: '+kz+'\nFIN/VIN: '+g('v_vin')+'\nGutachten-Nr.: '+g('f_gnr')+'\n\n'+
    'Mit freundlichen Gr√º√üen\nSBO Service B√ºro Oberhavel GmbH\nOliver Sch√∂nrock ¬∑ Tel. 03302 801505 ¬∑ info@ohv-service.de';
  document.getElementById('mfin').classList.add('open');
}
function sendMail(){
  const to=document.getElementById('eto').value.trim();if(!to){toast('Empf√§nger-E-Mail eingeben.','er');return;}
  const href='mailto:'+encodeURIComponent(to)+
    '?cc='+encodeURIComponent(document.getElementById('ecc').value)+
    '&subject='+encodeURIComponent(document.getElementById('esub').value)+
    '&body='+encodeURIComponent(document.getElementById('ebody').value);
  window.location.href=href;
  toast('E-Mail-Programm wird ge√∂ffnet‚Ä¶','ok');
}

// ================================================================
// TOAST
// ================================================================
function toast(msg,type=''){
  const t=document.getElementById('toast');t.textContent=msg;
  t.className='toast '+(type?type:'')+' show';
  setTimeout(()=>t.classList.remove('show'),4000);
}

// ================================================================
// RESET
// ================================================================
function resetForm(){
  if(!confirm('Alle Eingaben l√∂schen und neu beginnen?'))return;
  document.querySelectorAll('input[type=text],input[type=email],input[type=tel],input[type=number],input[type=date],input[type=time],input[type=month]').forEach(e=>e.value='');
  document.querySelectorAll('select').forEach(e=>e.selectedIndex=0);
  [1,2,3].forEach(n=>clrSig(n));
  document.getElementById('vip').style.display='none';
  document.getElementById('orbox').style.display='none';
  document.getElementById('errbox').style.display='none';
  document.getElementById('hres').style.display='none';
  document.getElementById('cz').classList.remove('hi');
  document.querySelectorAll('.tb').forEach(b=>b.className='tb');
  document.getElementById('q1d').style.display='none';
  goStep(1);toast('Formular zur√ºckgesetzt');
}

// ================================================================
// PDF GENERATION
// ================================================================
async function generatePDF(){
  if(!window.jspdf){toast('jsPDF wird geladen‚Ä¶');return;}
  toast('PDF wird erstellt‚Ä¶');
  await new Promise(r=>setTimeout(r,60));

  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  const W=210,H=297;

  // Color helpers
  const RED=[232,53,42],DARK=[26,26,46],MGRAY=[100,100,100],LGRAY=[230,228,226],BGRAY=[247,246,243],WHITE=[255,255,255],GREEN=[45,122,79],MIDGRAY=[160,160,160];

  const fc=rgb=>doc.setFillColor(...rgb);
  const dc=rgb=>doc.setDrawColor(...rgb);
  const tc=rgb=>doc.setTextColor(...rgb);
  const sf=(style,size)=>{doc.setFont('helvetica',style);doc.setFontSize(size);};
  const fr=(x,y,w,h,rgb)=>{fc(rgb);doc.rect(x,y,w,h,'F');};
  const ln=(x1,y1,x2,y2,rgb=LGRAY,lw=0.2)=>{doc.setLineWidth(lw);dc(rgb);doc.line(x1,y1,x2,y2);};
  const tx=(t,x,y,opts={})=>doc.text(String(t||''),x,y,opts);
  const bx=(x,y,w,h,fillRgb,strokeRgb)=>{fr(x,y,w,h,fillRgb);if(strokeRgb){dc(strokeRgb);doc.setLineWidth(0.2);doc.rect(x,y,w,h);}};

  // ----------------------------------------------------------------
  // PAGE 1
  // ----------------------------------------------------------------
  // Header
  fr(0,0,W,22,DARK);
  fr(0,22,W,1.5,RED);
  sf('normal',6.5);tc([180,180,200]);tx('KFZ-Sachverst√§ndigenb√ºro & Werbeagentur',W/2,5,{align:'center'});
  sf('bold',15);tc(RED);tx('AUFTRAG',W/2,11,{align:'center'});
  sf('normal',8);tc(WHITE);tx('zur Erstellung eines Gutachtens',W/2,16.5,{align:'center'});
  sf('bold',8);tc([255,180,180]);tx('SBO Service B√ºro Oberhavel GmbH',W-7,8,{align:'right'});
  sf('normal',5.5);tc([180,180,200]);tx('Auftragsformular 2025-2.0  ¬©  Copyright bei SBO GmbH',W-7,13.5,{align:'right'});

  // Meta bar
  fr(0,24,W,8,BGRAY);dc(LGRAY);doc.setLineWidth(0.2);doc.rect(0,24,W,8);
  sf('bold',6);tc(DARK);
  tx('Auftragsdatum',6,29);sf('normal',6);tc(MGRAY);tx(dFmt('f_adat'),36,29);
  sf('bold',6);tc(DARK);tx('Schadentag',72,29);sf('normal',6);tc(MGRAY);tx(dFmt('f_sdat'),90,29);
  sf('bold',6);tc(DARK);tx('um',118,29);sf('normal',6);tc(MGRAY);tx(g('f_szeit'),124,29);
  sf('bold',6);tc(DARK);tx('Gutachten-Nr.',150,29);sf('normal',6);tc(MGRAY);tx(g('f_gnr'),170,29);

  // Section headers
  const SY=33;
  fr(0,SY,105,6,DARK);fr(105,SY,W-105,6,DARK);fr(175,SY,W-175,6,[60,60,80]);
  sf('bold',7);tc(WHITE);
  tx('Fahrzeughalter / Auftraggeber',3,SY+4.2);
  tx('Fahrzeug - Daten',107,SY+4.2);
  tx('Schl√ºssel-Nr.',177,SY+4.2);

  // Left col: Auftraggeber
  const LW=105,RH=6;
  const leftRows=[
    ['C.1.1','Name / Firma',g('f_name')],
    ['C.1.2','Vorname',g('f_vname')],
    ['C.1.3','PLZ / Wohnort',g('f_plz')+(g('f_ort')?' '+g('f_ort'):'')],
    ['C.1.3','Stra√üe',g('f_str')],
    ['','Telefon',g('f_tel')],
    ['','E-Mail',g('f_mail')],
  ];
  leftRows.forEach((r,i)=>{
    const y=SY+6+i*RH;
    fr(0,y,LW,RH,i%2===0?BGRAY:WHITE);
    dc(LGRAY);doc.setLineWidth(0.15);doc.rect(0,y,LW,RH);
    if(r[0]){sf('bold',5.5);tc(RED);tx(r[0],2,y+4);}
    sf('bold',6);tc([70,70,70]);tx(r[1],r[0]?9:2,y+4);
    sf('normal',6.5);tc(DARK);tx(r[2],r[0]?32:26,y+4);
  });

  // Bevollm√§chtigter header
  const BVY=SY+6+leftRows.length*RH;
  fr(0,BVY,LW,5.5,[50,50,70]);
  sf('bold',5.5);tc(WHITE);tx('Bevollm√§chtigter Auftraggeber',2,BVY+3.8);
  const bevRows=[
    ['','Name',g('b_name')],['','Vorname',g('b_vname')],
    ['','PLZ / Wohnort',g('b_plz')+(g('b_ort')?' '+g('b_ort'):'')],
    ['','Stra√üe',g('b_str')],['','Telefon',g('b_tel')],['','Sonstiges',g('b_son')],
  ];
  bevRows.forEach((r,i)=>{
    const y=BVY+5.5+i*RH;
    fr(0,y,LW,RH,i%2===0?BGRAY:WHITE);
    dc(LGRAY);doc.setLineWidth(0.15);doc.rect(0,y,LW,RH);
    sf('bold',5.5);tc([70,70,70]);tx(r[1],2,y+4);
    sf('normal',6);tc(DARK);tx(r[2],26,y+4);
  });

  // Besichtigung
  const BSY=BVY+5.5+bevRows.length*RH;
  [
    ['Besichtigung',dFmt('f_adat'),'Uhrzeit',g('f_bzeit')],
    ['Besichtigungsort',g('f_bort'),'',''],
    ['Sonstiges',g('f_son'),'',''],
  ].forEach((r,i)=>{
    const y=BSY+i*RH;
    fr(0,y,LW,RH,i%2===0?[240,238,234]:BGRAY);
    dc(LGRAY);doc.setLineWidth(0.15);doc.rect(0,y,LW,RH);
    sf('bold',5.5);tc([70,70,70]);tx(r[0],2,y+4);sf('normal',6);tc(DARK);tx(r[1],26,y+4);
    if(r[2]){sf('bold',5.5);tc([70,70,70]);tx(r[2],60,y+4);sf('normal',6);tc(DARK);tx(r[3],72,y+4);}
  });

  // Right col: Fahrzeugdaten ‚Äî volle Breite bis zum Rand
  // Schl√ºsselnummern (2.1, 2.2, S.1) als eigene Zeilen direkt √ºber Kennzeichen
  const RX=105, FDW=W-RX;

  const vRows=[
    // Schl√ºsselnummern oben ‚Äî √ºber dem Kennzeichen
    ['2.1','Hersteller-Schl√ºsselnr. (HSN)',g('v_s21'),true],
    ['2.2','Typ-Schl√ºsselnr. (TSN)',g('v_s22'),true],
    ['S.1','Sitzpl√§tze',g('v_sp'),false],
    // Trennlinie / Abstand dann Fahrzeugdaten
    ['A','Amtl. Kennzeichen',g('v_kz'),true],
    ['5/J','Aufbauart',g('v_auf'),false],
    ['D.1','Hersteller / Marke',g('v_her'),false],
    ['D.2','Typ und Ausf√ºhrung',g('v_typ'),false],
    ['E','FIN / VIN',g('v_vin'),true],
    ['P.3','Antriebsart',g('v_ant'),false],
    ['P.2/P.1','kW / Hubraum cm¬≥',(g('v_kw')?g('v_kw')+' kW':'')+(g('v_hub')?' / '+g('v_hub')+' cm¬≥':''),false],
    ['G','Leergewicht kg',g('v_lg'),false],
    ['F.1','Zul. Gesamtgew. kg',g('v_gg'),false],
    ['15.1','Reifen vorn',g('v_rv'),false],
    ['15.2','Reifen hinten',g('v_rh'),false],
    ['B','Erstzulassung',dFmt('v_ez'),false],
    ['R','Farbe / km-Stand',g('v_farbe')+(g('v_km')?' / '+g('v_km')+' km':''),false],
    ['T√úV','T√úV / AU bis',g('v_tuev')+(g('v_au')?' / '+g('v_au'):''),false],
  ];

  // Kleine Trennlinie nach den ersten 3 Schl√ºsselzeilen
  vRows.forEach((r,i)=>{
    const y=SY+6+i*RH;
    const isSK=i<3; // erste 3 = Schl√ºsselnummern
    fr(RX,y,FDW,RH,isSK?[238,235,230]:(i%2===0?BGRAY:WHITE));
    dc(LGRAY);doc.setLineWidth(0.15);doc.rect(RX,y,FDW,RH);
    sf('bold',5.5);tc(RED);tx(r[0],RX+1.5,y+4);
    sf('bold',5.5);tc([70,70,70]);tx(r[1],RX+10,y+4);
    if(r[3]){sf('bold',6.5);tc(DARK);}else{sf('normal',6);tc(DARK);}
    const vStr=String(r[2]||'').slice(0,32);
    tx(vStr,RX+58,y+4);
  });
  // Trennlinie nach Schl√ºsselnummern (nach Zeile 2, vor Zeile 3=Kennzeichen)
  dc(RED);doc.setLineWidth(0.4);doc.line(RX,SY+6+3*RH,W,SY+6+3*RH);

  // Versicherung + Fragen section
  const VSY=Math.max(SY+6+vRows.length*RH+2, BSY+3*RH+5);
  fr(0,VSY,W,6,DARK);
  sf('bold',7);tc(WHITE);
  tx('Regulierende Versicherung',3,VSY+4.3);
  tx('Fragen an den Kunden:',W/2+5,VSY+4.3);

  const vsLeft=[
    [(document.querySelector('input[name="va"]:checked')||{}).value||'','Art der Regulierung'],
    [g('vs_n'),'Versicherung'],
    [g('vs_nr'),'Versicherungs-Nr.'],
    [g('vs_sn'),'Schaden-Nr.'],
    [g('vs_nh'),'Versicherungsnehmer'],
    [g('vs_kz'),'KZ Unfallgegner'],
  ];
  const vsRight=[
    ['Vorsch√§den vorhanden?',qv('q1')],
    ['Wenn ja, wo?',qv('q1')==='Ja'?g('q1w'):''],
    ['Vorschaden beseitigt?',qv('q2')],
    ['Vorsteuerabzugsberechtigt?',qv('q3')],
    ['Fahrzeug wird repariert?',qv('q4')],
    ['Abrechnung Gutachtenbasis?',qv('q5')],
  ];
  const VRH=6;
  vsLeft.forEach((r,i)=>{
    const y=VSY+6+i*VRH;
    fr(0,y,W/2,VRH,i%2===0?BGRAY:WHITE);dc(LGRAY);doc.setLineWidth(0.15);doc.rect(0,y,W/2,VRH);
    sf('bold',5.5);tc([70,70,70]);tx(r[1],2,y+4);
    sf('normal',6.5);tc(DARK);tx(String(r[0]).slice(0,28),32,y+4);
  });
  vsRight.forEach((r,i)=>{
    const y=VSY+6+i*VRH;const x=W/2;
    fr(x,y,W-x,VRH,i%2===0?BGRAY:WHITE);dc(LGRAY);doc.setLineWidth(0.15);doc.rect(x,y,W-x,VRH);
    sf('bold',5.5);tc([70,70,70]);tx(r[0],x+2,y+4);
    sf('bold',6);tc(r[1]==='Ja'?GREEN:DARK);tx(r[1],W-4,y+4,{align:'right'});
  });

  // Vertragstext
  const VTY=VSY+6+vsLeft.length*VRH+2;
  fr(0,VTY,W,5.5,RED);
  sf('bold',7);tc(WHITE);tx('Auftrag / Vertrag zur Erstellung eines Gutachtens durch das SBO Kfz-Sachverst√§ndigenb√ºro',W/2,VTY+3.8,{align:'center'});
  const vtTxt='1. Vertragsgegenstand: Der Auftraggeber beauftragt die SBO Service B√ºro Oberhavel GmbH mit der Erstellung eines Gutachtens (Grundlage: BGB, HGB, Schadensersatzrecht, DSGVO). 2. Verg√ºtung: Der Auftraggeber akzeptiert die umseitige Verg√ºtungsvereinbarung im vollen Umfang (Werkvertrag ¬ß 631 BGB). 3. Zahlungsbedingungen: Rechnung zahlbar innerhalb 14 Tagen ab Rechnungsdatum. Bei Zahlungsverzug √úbergabe an Forderungsmanagement. Zahlungsanweisung an Versicherung entbindet nicht von eigener Zahlungspflicht. 4. Nichtabholung: Gutachtengeb√ºhren werden auch bei Nichtabnahme f√§llig. 5. Bevollm√§chtigter: Versichert im Auftrag des Fahrzeughalters zu handeln. 6. Einverst√§ndnis: Auftraggeber erkl√§rt sich mit Digitalisierung aller Angaben und der Unterschrift einverstanden. 7. Recht: Deutsches Recht, Gerichtsstand Sitz des Auftragnehmers. 8. Sonstiges: Alle √Ñnderungen bed√ºrfen der Schriftform.';
  sf('normal',5);tc([55,55,55]);
  const vtLines=doc.splitTextToSize(vtTxt,W-4);
  let vtY=VTY+5.5+2;
  vtLines.forEach(l=>{if(vtY<H-68){tx(l,2,vtY);vtY+=3;}});

  // ============================================================
  // UNTERSCHRIFTEN SEITE 1
  // Sig1 = Auftragserteilung (obere Box, ca. 30mm hoch)
  // Sig2 = Zahlungsanweisung (untere Box, ca. 22mm hoch)
  // ============================================================
  const SIG1_Y=H-68;
  const SIG1_H=28;
  const SIG2_HEADER_H=6;
  const SIG2_Y=SIG1_Y+SIG1_H+SIG2_HEADER_H;
  const SIG2_H=H-SIG2_Y-5;

  // Sig1 background
  ln(0,SIG1_Y,W,SIG1_Y,RED,0.5);
  fr(0,SIG1_Y,W,SIG1_H,BGRAY);
  dc(LGRAY);doc.setLineWidth(0.15);doc.rect(0,SIG1_Y,W,SIG1_H);

  // Sig1: left text
  const s1Txt='Mit meiner Unterschrift erteile ich den Auftrag zur Erstellung eines Gutachtens und erkl√§re, dass ich den Auftrag / Vertrag gelesen habe und f√ºr die vollst√§ndige Begleichung der Rechnung allein verantwortlich bin! Ich erkl√§re mich mit der Digitalisierung meiner Unterschrift einverstanden!';
  sf('normal',5);tc([60,60,60]);
  const s1Lines=doc.splitTextToSize(s1Txt,W*0.5-3);
  s1Lines.forEach((l,i)=>tx(l,3,SIG1_Y+4+i*3));

  // Sig1: right ‚Äî signature box
  const SF1_X=W*0.52,SF1_W=W-SF1_X-3,SF1_MARGIN=2;
  bx(SF1_X,SIG1_Y+SF1_MARGIN,SF1_W,SIG1_H-SF1_MARGIN*2,WHITE,[180,180,180]);
  // EMBED SIG 1 ‚Äî fills the box, drawn before labels so labels stay on top
  const sig1img=getSigPNG(1);
  if(sig1img){
    try{
      // Fill the entire inner box with the signature image
      const si1x=SF1_X+2, si1y=SIG1_Y+SF1_MARGIN+2;
      const si1w=SF1_W-4, si1h=SIG1_H-SF1_MARGIN*2-4;
      doc.addImage(sig1img,'PNG',si1x,si1y,si1w,si1h,'sig1','FAST');
    }catch(e){console.warn('Sig1 embed failed',e);}
  } else {
    // Placeholder text if no signature
    sf('normal',6);tc(MIDGRAY);tx('(nicht unterschrieben)',SF1_X+SF1_W/2,SIG1_Y+SIG1_H/2+1,{align:'center'});
  }
  // Label + X drawn ON TOP of signature
  sf('bold',5);tc(MIDGRAY);tx('Unterschrift Auftragserteilung',SF1_X+SF1_W/2,SIG1_Y+SF1_MARGIN+3.5,{align:'center'});
  sf('bold',13);tc(RED);tx('X',SF1_X+2,SIG1_Y+SIG1_H-3);
  ln(SF1_X+9,SIG1_Y+SIG1_H-2,SF1_X+SF1_W-2,SIG1_Y+SIG1_H-2,[150,150,150],0.4);

  // Sig2 header bar
  fr(0,SIG1_Y+SIG1_H,W,SIG2_HEADER_H,DARK);
  sf('bold',6.5);tc(WHITE);
  tx('Zahlungsanweisung an die regulierende Versicherung zugunsten des Sachverst√§ndigenb√ºros',W/2,SIG1_Y+SIG1_H+4.2,{align:'center'});

  // Sig2 background
  fr(0,SIG2_Y,W,SIG2_H,[255,253,250]);
  dc(LGRAY);doc.setLineWidth(0.15);doc.rect(0,SIG2_Y,W,SIG2_H);

  // Sig2 left text
  const s2Txt='Der Auftraggeber weist das Versicherungsunternehmen unwiderruflich an, den Rechnungsbetrag in ungek√ºrzter H√∂he des Bruttobetrages direkt an die SBO Service B√ºro Oberhavel GmbH zu zahlen. Diese Zahlungsanweisung entbindet den Auftraggeber nicht von seiner Zahlungspflicht. Mit meiner Unterschrift stimme ich der Zahlungsanweisung unwiderruflich zu!';
  sf('normal',5);tc([60,60,60]);
  const s2Lines=doc.splitTextToSize(s2Txt,W*0.5-3);
  s2Lines.forEach((l,i)=>tx(l,3,SIG2_Y+4+i*3));

  // Sig2 right ‚Äî signature box
  const SF2_X=W*0.52,SF2_W=W-SF2_X-3,SF2_MARGIN=2;
  bx(SF2_X,SIG2_Y+SF2_MARGIN,SF2_W,SIG2_H-SF2_MARGIN*2,WHITE,[180,180,180]);
  // EMBED SIG 2
  const sig2img=getSigPNG(2);
  if(sig2img){
    try{
      const si2x=SF2_X+2, si2y=SIG2_Y+SF2_MARGIN+2;
      const si2w=SF2_W-4, si2h=SIG2_H-SF2_MARGIN*2-4;
      doc.addImage(sig2img,'PNG',si2x,si2y,si2w,si2h,'sig2','FAST');
    }catch(e){console.warn('Sig2 embed failed',e);}
  } else {
    sf('normal',6);tc(MIDGRAY);tx('(nicht unterschrieben)',SF2_X+SF2_W/2,SIG2_Y+SIG2_H/2,{align:'center'});
  }
  sf('bold',5);tc(MIDGRAY);tx('Unterschrift Zahlungsanweisung',SF2_X+SF2_W/2,SIG2_Y+SF2_MARGIN+3.5,{align:'center'});
  sf('bold',13);tc(RED);tx('X',SF2_X+2,SIG2_Y+SIG2_H-2);
  ln(SF2_X+9,SIG2_Y+SIG2_H-1,SF2_X+SF2_W-2,SIG2_Y+SIG2_H-1,[150,150,150],0.4);

  // Page 1 footer
  ln(0,H-3.5,W,H-3.5,RED,0.5);
  sf('normal',4);tc([140,140,140]);
  tx('SBO Service B√ºro Oberhavel GmbH ¬∑ 16761 Hennigsdorf ¬∑ Neuendorfstrasse 07 ¬∑ Tel. 03302 801505 ¬∑ Fax 03302 801527 ¬∑ info@ohv-service.de ¬∑ HRB 14372 NP',W/2,H-1.5,{align:'center'});

  // ================================================================
  // PAGE 2 ‚Äî Verg√ºtungsvereinbarung
  // ================================================================
  doc.addPage();

  // Header P2
  fr(0,0,W,20,DARK);fr(0,20,W,1.5,RED);
  sf('bold',13);tc(WHITE);tx('Vereinbarung zur Verg√ºtung',W/2,9,{align:'center'});
  sf('normal',7);tc([200,200,210]);tx('f√ºr die Erstellung von Kfz-Schadengutachten',W/2,15,{align:'center'});
  sf('normal',5);tc([150,150,170]);tx('SBO Service B√ºro Oberhavel GmbH ¬∑ Auftragsformular 2025-2.0',W/2,19.5,{align:'center'});

  let p2y=24;
  // Intro text
  sf('normal',5.8);tc([55,55,55]);
  const introTxt='Diese Vereinbarung zur Verg√ºtung (1*/2*/3*/4*) f√ºr die Erstellung von Kfz-Schadengutachten ist Bestandteil des Auftrages und wird vom Auftraggeber mit seiner Unterschrift anerkannt!';
  const introLines=doc.splitTextToSize(introTxt,W-8);
  introLines.forEach(l=>{tx(l,4,p2y);p2y+=3.2;});p2y+=3;

  // Festbetrag box
  fr(4,p2y,W-8,9,DARK);
  sf('bold',7);tc(WHITE);tx('Fahrzeugbewertung / Fahrzeugwertgutachten',7,p2y+4);
  sf('bold',9);tc(RED);tx('160,00 ‚Ç¨ Festbetrag zzgl. gesetzlicher MwSt.',W-8,p2y+6.5,{align:'right'});
  p2y+=12;

  // Erl√§uterungen
  fr(4,p2y,W-8,5.5,[235,233,230]);
  sf('bold',6.5);tc(DARK);tx('Erl√§uterungen:',7,p2y+3.8);p2y+=5.5;
  const erl=[
    '1. Ma√ügebend f√ºr die Schadenh√∂he: Im Reparaturfall: Reparaturkosten netto zzgl. Wertminderung. Im Totalschadenfall: Wiederbeschaffungswert brutto.',
    '2. Das Tableau bezieht sich auf Fahrzeuge, die mit Standardsoftware kalkulierbar sind.',
    '3. Fahrkosten: 2,83 ‚Ç¨ (netto 2,00 ‚Ç¨) pro km. Online-Restwerteinholung: 20,83 ‚Ç¨ (netto 17,50 ‚Ç¨).',
    '4. Das Tableau bildet f√ºr eine zweifache Ausfertigung des Gutachtens Bruttoendbetr√§ge ab (Grundhonorar + Nebenkostenpauschale).',
    '5. Das Netto-Grundhonorar basiert auf BVSK-Honorarbefragung 2022 (Mittelwert HB II/IV). Nebenkostenpauschale netto 80,00 ‚Ç¨.',
    '6. Diese Tabelle stellt keine verbindliche Preisempfehlung dar. G√ºltig ab 02.04.2025.',
  ];
  sf('normal',5.2);tc([60,60,60]);
  erl.forEach(e=>{const ls=doc.splitTextToSize(e,W-8);ls.forEach(l=>{tx(l,4,p2y);p2y+=2.9;});p2y+=0.5;});
  p2y+=2;

  // Table header
  fr(4,p2y,W-8,7,DARK);
  sf('bold',6.5);tc(WHITE);tx('SV-Honorartableau gem√§√ü HUK-Schadenregulierung',W/2,p2y+4.5,{align:'center'});p2y+=7;

  // Column headers
  const tW=W-8,cW=tW/3;
  fr(4,p2y,tW,5.5,[50,50,75]);
  sf('bold',5.5);tc(WHITE);
  tx('Schadenh√∂he bis',6,p2y+3.8);tx('Brutto',6+cW*0.45,p2y+3.8);tx('Netto',6+cW*0.7,p2y+3.8);
  tx('Schadenh√∂he bis',6+cW,p2y+3.8);tx('Brutto',6+cW*1.45,p2y+3.8);tx('Netto',6+cW*1.7,p2y+3.8);
  tx('Schadenh√∂he bis',6+cW*2,p2y+3.8);tx('Brutto',6+cW*2.45,p2y+3.8);tx('Netto',6+cW*2.7,p2y+3.8);
  p2y+=5.5;

  const perCol=Math.ceil(HT.length/3);
  const rh=4.2;
  for(let col=0;col<3;col++){
    const slice=HT.slice(col*perCol,(col+1)*perCol);
    const cx=4+col*cW;
    let ry=p2y;
    slice.forEach((r,i)=>{
      fr(cx,ry,cW,rh,i%2===0?BGRAY:WHITE);
      dc(LGRAY);doc.setLineWidth(0.1);doc.rect(cx,ry,cW,rh);
      sf('normal',5.5);tc(DARK);tx(r[0].toLocaleString('de-DE')+' ‚Ç¨',cx+1.5,ry+3);
      sf('bold',5.5);tc(DARK);tx(r[1].toFixed(2).replace('.',',')+' ‚Ç¨',cx+cW*0.42,ry+3);
      sf('normal',5.5);tc(MGRAY);tx(r[2].toFixed(2).replace('.',',')+' ‚Ç¨',cx+cW*0.70,ry+3);
      ry+=rh;
    });
  }
  p2y+=perCol*rh+3;

  // Nebenkosten
  fr(4,p2y,W-8,5.5,RED);sf('bold',6);tc(WHITE);tx('Nebenkosten',W/2,p2y+3.8,{align:'center'});p2y+=5.5;
  const nk=[
    ['Aufwandspauschale gem√§√ü HUK¬≤*','59,50 ‚Ç¨','50,00 ‚Ç¨'],
    ['Fahrtkosten pro km An-/R√ºckfahrt gem√§√ü HUK¬≤*','2,83 ‚Ç¨','2,00 ‚Ç¨'],
    ['Restwert-Einholung online gem√§√ü HUK¬≤*','20,83 ‚Ç¨','17,50 ‚Ç¨'],
    ['Kurzgutachten / Kostenvoranschlag','136,85 ‚Ç¨','115,00 ‚Ç¨'],
  ];
  nk.forEach((r,i)=>{
    fr(4,p2y,W-8,5,i%2===0?BGRAY:WHITE);dc(LGRAY);doc.setLineWidth(0.1);doc.rect(4,p2y,W-8,5);
    sf('normal',5.8);tc(DARK);tx(r[0],7,p2y+3.5);
    sf('bold',5.8);tc(DARK);tx(r[1],W-50,p2y+3.5);
    sf('normal',5.8);tc(MGRAY);tx(r[2],W-25,p2y+3.5);
    p2y+=5;
  });p2y+=3;

  // Footnotes
  const fns=[
    '1* Zeitabrechnung: 165,00 ‚Ç¨ je Stunde zzgl. MwSt. zzgl. Nebenkosten.',
    '2* HUK-Tableau: Abrechnung gem√§√ü aktuellem SV-Honorartableau der HUK-Coburg Schadenregulierung zzgl. vereinbarter Nebenkosten.',
    '3* Europcar-Vereinbarung: Gem√§√ü gesonderter Abrechnungsvereinbarung.',
    '4* Geb√ºhrenkalkulation: Gem√§√ü interner Kalkulation des SBO Kfz-Sachverst√§ndigenb√ºros.',
  ];
  sf('normal',5);tc([100,100,100]);
  fns.forEach(f=>{const ls=doc.splitTextToSize(f,W-8);ls.forEach(l=>{tx(l,4,p2y);p2y+=2.7;});p2y+=0.5;});
  p2y+=2;

  // DSGVO
  fr(4,p2y,W-8,5,[235,233,230]);
  sf('normal',5.2);tc([70,70,70]);
  tx('Wir verarbeiten Ihre Vertragsdaten gem√§√ü Art. 6 Abs. 1 lit. b DSGVO. Die vollst√§ndige Datenschutzerkl√§rung finden Sie auf unserer Homepage.',7,p2y+3.5);
  p2y+=8;

  // ============================================================
  // UNTERSCHRIFT SEITE 2: Honorarvereinbarung
  // Text-Label √úBER der Box, Unterschrift f√ºllt Box vollst√§ndig
  // ============================================================
  // Gesamtbereich: Label-Zeile + Box
  const SIG3_LABEL_H=8; // H√∂he f√ºr Text oberhalb der Box
  const SIG3_BOX_H=Math.min(28, H-p2y-SIG3_LABEL_H-8);
  const SIG3_Y=p2y;

  // Text-Label au√üerhalb/oberhalb der Unterschriftenbox
  fr(4,SIG3_Y,W-8,SIG3_LABEL_H,[232,53,42]); // roter Header-Balken
  sf('bold',6.5);tc(WHITE);
  tx('Mit meiner Unterschrift stimme ich dem SV-Honorartableau unwiderruflich zu!',W/2,SIG3_Y+5.2,{align:'center'});

  // Linke Seite: Ort/Datum + Name ‚Äî in eigenem Bereich
  const SIG3_BOX_Y=SIG3_Y+SIG3_LABEL_H;
  fr(4,SIG3_BOX_Y,W*0.48-4,SIG3_BOX_H,[247,246,243]);
  dc([180,180,180]);doc.setLineWidth(0.2);doc.rect(4,SIG3_BOX_Y,W*0.48-4,SIG3_BOX_H);
  sf('normal',5.5);tc([80,80,80]);
  tx('Ort, Datum:',7,SIG3_BOX_Y+7);
  ln(7+22,SIG3_BOX_Y+7,W*0.48-8,SIG3_BOX_Y+7,[160,160,160],0.3);
  tx('Auftraggeber: '+(g('f_name')||'________________________________'),7,SIG3_BOX_Y+SIG3_BOX_H-5);

  // Rechte Seite: Unterschriften-Box ‚Äî komplett frei f√ºr die Unterschrift
  const SF3_X=W*0.48, SF3_W=W-SF3_X-4;
  fr(SF3_X,SIG3_BOX_Y,SF3_W,SIG3_BOX_H,WHITE);
  dc([180,180,180]);doc.setLineWidth(0.3);doc.rect(SF3_X,SIG3_BOX_Y,SF3_W,SIG3_BOX_H);

  // Embed Sig3 ‚Äî fills entire right box
  const sig3img=getSigPNG(3);
  if(sig3img){
    try{
      doc.addImage(sig3img,'PNG',SF3_X+1,SIG3_BOX_Y+1,SF3_W-2,SIG3_BOX_H-2,'sig3','FAST');
    }catch(e){console.warn('Sig3 embed failed',e);}
  } else {
    sf('normal',5.5);tc(MIDGRAY);
    tx('Unterschrift',SF3_X+SF3_W/2,SIG3_BOX_Y+SIG3_BOX_H/2-1,{align:'center'});
    tx('Honorarvereinbarung',SF3_X+SF3_W/2,SIG3_BOX_Y+SIG3_BOX_H/2+3.5,{align:'center'});
  }
  // X + Linie am unteren Rand der Sig-Box
  sf('bold',13);tc(RED);tx('X',SF3_X+2,SIG3_BOX_Y+SIG3_BOX_H-2);
  ln(SF3_X+9,SIG3_BOX_Y+SIG3_BOX_H-1,SF3_X+SF3_W-2,SIG3_BOX_Y+SIG3_BOX_H-1,[150,150,150],0.4);

  // Footer P2
  ln(0,H-5,W,H-5,RED,0.5);
  sf('normal',4);tc([140,140,140]);
  tx('SBO Service B√ºro Oberhavel GmbH ¬∑ 16761 Hennigsdorf ¬∑ Neuendorfstrasse 07 ¬∑ Tel. 03302 801505 ¬∑ Fax 03302 801527 ¬∑ info@ohv-service.de ¬∑ HRB 14372 NP',W/2,H-3,{align:'center'});
  tx('Gesch√§ftsf√ºhrer und Kfz-Sachverst√§ndiger: Oliver Sch√∂nrock ¬∑ Mitglied des BVFS e.V. Nr. 2560/2418',W/2,H-1,{align:'center'});

  // ================================================================
  // SAVE
  // ================================================================
  const fname='SBO_Auftrag_'+(g('v_kz')||'neu')+'_'+new Date().toISOString().slice(0,10)+'.pdf';
  doc.save(fname);
  toast('‚úì PDF "'+fname+'" wird heruntergeladen!','ok');
}

// ================================================================
// INIT
// ================================================================
document.addEventListener('DOMContentLoaded',()=>{
  // Pre-fill key input if saved
  try{
    const k=localStorage.getItem('sbo_akey');
    const inp=document.getElementById('apikey');
    const kc=document.getElementById('keyCard');
    if(k&&inp){
      inp.value=k;
      if(kc)kc.style.display='none'; // Key vorhanden ‚Üí Card verstecken
    }
    // else: kein Key ‚Üí Card bleibt sichtbar (bereits style ohne display:none)
  }catch(e){}
  [1,2,3].forEach(n=>initSig(n));
  document.getElementById('f_adat').value=new Date().toISOString().split('T')[0];
  initGnr();
  updNav();
});
</script>
</body>
</html>
